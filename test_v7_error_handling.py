#!/usr/bin/env python3
"""
Test v7 implementation with improved error handling
"""

import subprocess
import time
import requests
import json
import sys
import os

def test_v7_error_handling():
    """Test the v7 implementation with various edge cases"""
    print("üöÄ Testing MCP Server v7 with Enhanced Error Handling")
    print("=" * 60)
    
    # Start the v7 server as a subprocess
    server_process = None
    try:
        # Kill any existing servers
        os.system("lsof -ti:8080 | xargs kill -9 2>/dev/null || true")
        time.sleep(1)
        
        # Start the server
        print("\nüîß Starting v7 server...")
        env = os.environ.copy()
        env['PORT'] = '8080'
        env['TRANSPORT'] = 'sse'
        
        server_process = subprocess.Popen(
            [sys.executable, 'src/mcp/sse_server_v7.py'],
            cwd='/Users/ma3u/projects/StrunzKnowledge',
            env=env,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True
        )
        
        # Give server time to start
        print("‚è≥ Waiting for server to start...")
        time.sleep(4)
        
        # Check if server is running
        if server_process.poll() is not None:
            output, _ = server_process.communicate()
            print(f"‚ùå Server failed to start!")
            print(f"Output: {output}")
            return False
        
        print("‚úÖ Server started successfully")
        
        # Run tests
        base_url = "http://localhost:8080"
        results = []
        
        # Test 1: Health check
        print("\nüìç Testing health check...")
        try:
            response = requests.get(f"{base_url}/health", timeout=5)
            success = response.status_code == 200
            print(f"{'‚úÖ' if success else '‚ùå'} Health: {response.status_code}")
            if success:
                data = response.json()
                print(f"   Version: {data.get('version', 'unknown')}")
                print(f"   Improvements: {', '.join(data.get('improvements', []))}")
            results.append(("Health Check", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Health: Error - {e}")
            results.append(("Health Check", False, 0))
        
        # Test 2: Initialize
        print("\nüîß Testing MCP Initialize...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 1,
                "method": "initialize",
                "params": {
                    "protocolVersion": "2025-11-05",
                    "capabilities": {},
                    "clientInfo": {
                        "name": "test-client-v7",
                        "version": "7.0.0"
                    }
                }
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=5)
            
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} Initialize: {response.status_code}")
            results.append(("Initialize", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Initialize: Error - {e}")
            results.append(("Initialize", False, 0))
        
        # Test 3: List tools
        print("\nüìã Testing tools listing...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 2,
                "method": "tools/list",
                "params": {}
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=5)
            
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} List Tools: {response.status_code}")
            
            if success and response.text:
                try:
                    data = json.loads(response.text)
                    if 'result' in data and 'tools' in data['result']:
                        tools = data['result']['tools']
                        print(f"   Found {len(tools)} tools")
                except:
                    pass
            
            results.append(("List Tools", success, response.status_code))
        except Exception as e:
            print(f"‚ùå List Tools: Error - {e}")
            results.append(("List Tools", False, 0))
        
        # Test 4: Basic search (should work)
        print("\nüîç Testing basic search...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 3,
                "method": "tools/call",
                "params": {
                    "name": "search_knowledge",
                    "arguments": {
                        "query": "Vitamin D",
                        "limit": 5
                    }
                }
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=10)
            
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} Basic Search: {response.status_code}")
            
            if success and response.text:
                try:
                    data = json.loads(response.text)
                    if 'result' in data:
                        result = data['result']
                        print(f"   Result preview: {result[:100]}...")
                except:
                    pass
            
            results.append(("Basic Search", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Basic Search: Error - {e}")
            results.append(("Basic Search", False, 0))
        
        # Test 5: Edge case - empty query
        print("\nüîç Testing empty query (should fail gracefully)...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 4,
                "method": "tools/call",
                "params": {
                    "name": "search_knowledge",
                    "arguments": {
                        "query": "",
                        "limit": 5
                    }
                }
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=10)
            
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} Empty Query Handling: {response.status_code}")
            
            if success and response.text:
                try:
                    data = json.loads(response.text)
                    if 'result' in data:
                        result = data['result']
                        if "Error:" in result:
                            print(f"   ‚úÖ Proper error message: {result}")
                except:
                    pass
            
            results.append(("Empty Query", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Empty Query: Error - {e}")
            results.append(("Empty Query", False, 0))
        
        # Test 6: Advanced search with filtering
        print("\nüîç Testing advanced search with filtering...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 5,
                "method": "tools/call",
                "params": {
                    "name": "search_knowledge_advanced",
                    "arguments": {
                        "query": "Protein",
                        "content_types": ["books"],
                        "limit": 3
                    }
                }
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=10)
            
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} Advanced Search: {response.status_code}")
            
            if success and response.text:
                try:
                    data = json.loads(response.text)
                    if 'result' in data:
                        result = data['result']
                        if "books" in result.lower():
                            print(f"   ‚úÖ Filtered to books only")
                except:
                    pass
            
            results.append(("Advanced Search", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Advanced Search: Error - {e}")
            results.append(("Advanced Search", False, 0))
        
        # Test 7: Edge case - invalid parameters
        print("\nüîç Testing invalid parameters (should handle gracefully)...")
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 6,
                "method": "tools/call",
                "params": {
                    "name": "search_knowledge",
                    "arguments": {
                        "query": "test",
                        "filter_source": ["books"]  # Wrong parameter name
                    }
                }
            }
            
            response = requests.post(f"{base_url}/", 
                                   json=payload,
                                   headers={'Content-Type': 'application/json'},
                                   timeout=10)
            
            # Should still succeed but ignore invalid parameter
            success = response.status_code in [200, 202]
            print(f"{'‚úÖ' if success else '‚ùå'} Invalid Parameter Handling: {response.status_code}")
            
            results.append(("Invalid Params", success, response.status_code))
        except Exception as e:
            print(f"‚ùå Invalid Params: Error - {e}")
            results.append(("Invalid Params", False, 0))
        
        # Summary
        print("\n" + "=" * 60)
        total_tests = len(results)
        passed_tests = sum(1 for _, success, _ in results if success)
        success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
        
        print(f"üìä Test Results: {passed_tests}/{total_tests} passed ({success_rate:.1f}%)")
        
        if success_rate == 100:
            print("üü¢ Overall Status: PERFECT! v7 handles all cases correctly")
        elif success_rate >= 80:
            print("üü° Overall Status: GOOD - Most cases handled properly")
        else:
            print("üî¥ Overall Status: ISSUES - Error handling needs work")
        
        print("\nüìù Test Summary:")
        print("-" * 40)
        for test_name, success, status_code in results:
            status = "‚úÖ PASS" if success else "‚ùå FAIL"
            print(f"{test_name:20} {status:8} (HTTP {status_code})")
        
        return success_rate >= 80
        
    except Exception as e:
        print(f"‚ùå Test error: {e}")
        return False
        
    finally:
        # Clean up
        if server_process:
            print("\nüõë Stopping server...")
            server_process.terminate()
            try:
                server_process.wait(timeout=5)
            except subprocess.TimeoutExpired:
                server_process.kill()
            print("‚úÖ Server stopped")

if __name__ == "__main__":
    test_v7_error_handling()